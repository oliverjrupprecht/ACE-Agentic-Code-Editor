import subprocess
from os.path import (
        abspath,
        join,
        isfile,
        normpath,
        exists
        )

def run_python_file(working_directory, file_path, args=[]):
    abs_working_path = abspath(working_directory)

    full_path = normpath(join(
                abs_working_path,
                file_path
                ))

    print(full_path)

    if not full_path.startswith(abs_working_path):
        return f'Error: Cannot read "{full_path}" as it is outside the permitted working directory'

    print(exists(full_path))

    if not exists(full_path):
        return f'Error: File "{full_path}" not found'

    if not full_path.endswith(".py"):
        return f'Error: "{full_path}" is not a python file'

    try:
        p = subprocess.run("python3", full_path, args, timeout=30, capture_output=True)

        out = f"STDOUT:{p.stdout}\nSTDERR:{p.stderr}"
        
        if p.returncode != 0:
            out += f"Process exited with code {p.returncode}"

        if p.stdout:
            out += f"\nNo output produced"
            
        return out
    except Exception as e:
        return f"Error: executing Python file: {e}"
